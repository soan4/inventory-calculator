<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é©æ­£åœ¨åº«è¨ˆç®—ã‚¢ãƒ—ãƒª</title>
    
    <!-- PWAè¨­å®š -->
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="é©æ­£åœ¨åº«è¨ˆç®—">
    <link rel="apple-touch-icon" sizes="192x192" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcikiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyek05IDE3bC01LTVoM1Y5aDRsMi0yaDR2Mmg0bC01IDV6Ii8+Cjwvc3ZnPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDBfbGluZWFyIiB4MT0iMCIgeTE9IjAiIHgyPSIxOTIiIHkyPSIxOTIiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agc3RvcC1jb2xvcj0iIzY2N2VlYSIvPgo8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiM3NjRiYTIiLz4KPC9saW5lYXJHcmFkaWVudD4KPC9kZWZzPgo8L3N2Zz4K">
    <link rel="manifest" href="#" id="manifest-placeholder">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .content {
            padding: 40px;
        }

        .form-section {
            margin-bottom: 40px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }

        .form-section h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.3em;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #34495e;
            margin-bottom: 8px;
            font-size: 0.95em;
        }

        input, select {
            padding: 12px;
            border: 2px solid #e0e6ed;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input:disabled {
            background-color: #f8f9fa;
            color: #6c757d;
            border-color: #e9ecef;
        }

        .data-mode-toggle {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .data-mode-toggle h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .toggle-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .toggle-btn {
            padding: 12px 24px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .toggle-btn.active {
            background: #667eea;
            color: white;
        }

        .toggle-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
        }

        .calculate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: block;
            margin: 30px auto;
            min-width: 200px;
        }

        .calculate-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.3);
        }

        .results {
            display: none;
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8f0 100%);
            border-radius: 10px;
            padding: 30px;
            margin-top: 30px;
            border-left: 4px solid #27ae60;
        }

        .results h3 {
            color: #27ae60;
            margin-bottom: 25px;
            font-size: 1.4em;
            text-align: center;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .result-item {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            text-align: center;
        }

        .result-item h4 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .result-value {
            font-size: 2em;
            font-weight: 700;
            color: #27ae60;
            margin-bottom: 5px;
        }

        .result-unit {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .calculation-details {
            margin-top: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e0e6ed;
        }

        .calculation-details h4 {
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .calculation-step {
            margin-bottom: 10px;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
        }

        .calculation-mode {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }

        .calculation-mode h5 {
            color: #1976d2;
            margin-bottom: 5px;
        }

        .calculation-mode p {
            color: #424242;
            font-size: 0.9em;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .content {
                padding: 20px;
            }
            
            .form-section {
                padding: 20px;
            }

            .toggle-buttons {
                flex-direction: column;
                align-items: center;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .result-grid {
                grid-template-columns: 1fr;
            }
        }

        /* PWAå°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media (display-mode: standalone) {
            .header {
                padding-top: 50px; /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼å¯¾å¿œ */
            }
            
            body {
                padding-top: 0;
            }
        }

        /* ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒãƒŠãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
        .install-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: center;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .install-banner.show {
            transform: translateY(0);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>é©æ­£åœ¨åº«è¨ˆç®—ã‚¢ãƒ—ãƒª</h1>
            <p>å°å£²æ¥­å‘ã‘åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ˜¨å¹´ãƒ‡ãƒ¼ã‚¿å¯¾å¿œç‰ˆï¼‰</p>
        </div>

        <div class="content">
            <div class="data-mode-toggle">
                <h3>ğŸ“Š ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰é¸æŠ</h3>
                <div class="toggle-buttons">
                    <button class="toggle-btn active" onclick="toggleDataMode('current')">ä»Šå¹´ãƒ‡ãƒ¼ã‚¿ã®ã¿</button>
                    <button class="toggle-btn" onclick="toggleDataMode('comparison')">æ˜¨å¹´ãƒ‡ãƒ¼ã‚¿ã¨æ¯”è¼ƒ</button>
                </div>
            </div>

            <div class="form-section">
                <h3>ğŸ“ˆ éå»4é€±é–“ã®è²©å£²å®Ÿç¸¾</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="week1">ç¬¬1é€± è²©å£²æ•°</label>
                        <input type="number" id="week1" min="0" placeholder="ä¾‹: 100">
                    </div>
                    <div class="form-group">
                        <label for="week2">ç¬¬2é€± è²©å£²æ•°</label>
                        <input type="number" id="week2" min="0" placeholder="ä¾‹: 120">
                    </div>
                    <div class="form-group">
                        <label for="week3">ç¬¬3é€± è²©å£²æ•°</label>
                        <input type="number" id="week3" min="0" placeholder="ä¾‹: 110">
                    </div>
                    <div class="form-group">
                        <label for="week4">ç¬¬4é€± è²©å£²æ•°</label>
                        <input type="number" id="week4" min="0" placeholder="ä¾‹: 130">
                    </div>
                </div>
            </div>

            <div class="form-section" id="last-year-section" style="display: none;">
                <h3>ğŸ“… æ˜¨å¹´åŒæœŸ4é€±é–“ã®è²©å£²å®Ÿç¸¾</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="last-week1">æ˜¨å¹´åŒé€± è²©å£²æ•°</label>
                        <input type="number" id="last-week1" min="0" placeholder="ä¾‹: 90">
                    </div>
                    <div class="form-group">
                        <label for="last-week2">æ˜¨å¹´1é€±å…ˆ è²©å£²æ•°</label>
                        <input type="number" id="last-week2" min="0" placeholder="ä¾‹: 95">
                    </div>
                    <div class="form-group">
                        <label for="last-week3">æ˜¨å¹´2é€±å…ˆ è²©å£²æ•°</label>
                        <input type="number" id="last-week3" min="0" placeholder="ä¾‹: 100">
                    </div>
                    <div class="form-group">
                        <label for="last-week4">æ˜¨å¹´3é€±å…ˆ è²©å£²æ•°</label>
                        <input type="number" id="last-week4" min="0" placeholder="ä¾‹: 105">
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h3>âš™ï¸ è¨­å®šãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="abc-rank">ABCãƒ©ãƒ³ã‚¯</label>
                        <select id="abc-rank">
                            <option value="A">Aãƒ©ãƒ³ã‚¯ (é«˜é‡è¦åº¦ãƒ»æ¬ å“å›é¿)</option>
                            <option value="B">Bãƒ©ãƒ³ã‚¯ (ä¸­é‡è¦åº¦ãƒ»æ¨™æº–ç®¡ç†)</option>
                            <option value="C">Cãƒ©ãƒ³ã‚¯ (ä½é‡è¦åº¦ãƒ»åœ¨åº«å‰Šæ¸›)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="lead-time">ãƒªãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ </label>
                        <input type="number" id="lead-time" value="4" min="1" max="30">
                        <small style="color: #7f8c8d; margin-top: 5px;">æ—¥æ•°</small>
                    </div>
                    <div class="form-group">
                        <label for="order-cycle">ç™ºæ³¨ã‚µã‚¤ã‚¯ãƒ«</label>
                        <input type="number" id="order-cycle" value="7" min="1" max="90">
                        <small style="color: #7f8c8d; margin-top: 5px;">æ—¥æ•°</small>
                    </div>
                </div>
            </div>

            <button class="calculate-btn" onclick="calculateInventory()">ğŸ“ˆ é©æ­£åœ¨åº«ã‚’è¨ˆç®—</button>

            <div class="results" id="results">
                <div class="calculation-mode" id="calculation-mode-display"></div>
                
                <h3>è¨ˆç®—çµæœ</h3>
                <div class="result-grid">
                    <div class="result-item">
                        <h4>ç™ºæ³¨ç‚¹</h4>
                        <div class="result-value" id="reorder-point">--</div>
                        <div class="result-unit">å€‹</div>
                    </div>
                    <div class="result-item">
                        <h4>é©æ­£åœ¨åº«ï¼ˆæœ€å¤§åœ¨åº«ï¼‰</h4>
                        <div class="result-value" id="max-inventory">--</div>
                        <div class="result-unit">å€‹</div>
                    </div>
                    <div class="result-item">
                        <h4>å¹³å‡æ—¥æ¬¡éœ€è¦</h4>
                        <div class="result-value" id="daily-demand">--</div>
                        <div class="result-unit">å€‹/æ—¥</div>
                    </div>
                    <div class="result-item">
                        <h4>å®‰å…¨åœ¨åº«</h4>
                        <div class="result-value" id="safety-stock">--</div>
                        <div class="result-unit">å€‹</div>
                    </div>
                </div>

                <div class="calculation-details">
                    <h4>è¨ˆç®—è©³ç´°</h4>
                    <div id="calculation-steps"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentDataMode = 'current';

        // PWAè¨­å®š
        window.addEventListener('load', () => {
            setupPWA();
        });

        function setupPWA() {
            // ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’å‹•çš„ã«ç”Ÿæˆ
            const manifestData = {
                "name": "é©æ­£åœ¨åº«è¨ˆç®—ã‚¢ãƒ—ãƒª",
                "short_name": "åœ¨åº«è¨ˆç®—",
                "description": "å°å£²æ¥­å‘ã‘é©æ­£åœ¨åº«ãƒ»ç™ºæ³¨ç‚¹è¨ˆç®—ã‚¢ãƒ—ãƒª",
                "start_url": "./",
                "display": "standalone",
                "background_color": "#ffffff",
                "theme_color": "#667eea",
                "orientation": "portrait",
                "icons": [
                    {
                        "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcikiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0yMCAzSDE0TDEwLjUgNi41TDEwIDdINFYxOEgxOFY3SDE2TDIwIDNaTTcgMTBIMTNWMTJIN1YxMFpNNyAxM0gxM1YxNUg3VjEzWk03IDE2SDEzVjE4SDdWMTZaIi8+Cjwvc3ZnPgo8ZGVmcz4KPGxpbmVhckdyYWRpZW50IGlkPSJncmFkaWVudDBfbGluZWFyIiB4MT0iMCIgeTE9IjAiIHgyPSIxOTIiIHkyPSIxOTIiIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIj4KPHN0b3Agc3RvcC1jb2xvcj0iIzY2N2VlYSIvPgo8c3RvcCBvZmZzZXQ9IjEiIHN0b3AtY29sb3I9IiM3NjRiYTIiLz4KPC9saW5lYXJHcmFkaWVudD4KPC9kZWZzPgo8L3N2Zz4K",
                        "sizes": "192x192",
                        "type": "image/svg+xml",
                        "purpose": "any maskable"
                    },
                    {
                        "src": "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTEyIiBoZWlnaHQ9IjUxMiIgdmlld0JveD0iMCAwIDUxMiA1MTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSI1MTIiIGhlaWdodD0iNTEyIiByeD0iNjQiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcikiLz4KPHN2ZyB4PSIxMjgiIHk9IjEyOCIgd2lkdGg9IjI1NiIgaGVpZ2h0PSIyNTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0id2hpdGUiPgo8cGF0aCBkPSJNMjAgM0gxNEwxMC41IDYuNUwxMCA3SDRWMThIMThWN0gxNkwyMCAzWk03IDEwSDEzVjEySDdWMTBaTTcgMTNIMTNWMTVIN1YxM1pNNyAxNkgxM1YxOEg3VjE2WiIvPgo8L3N2Zz4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZGllbnQwX2xpbmVhciIgeDE9IjAiIHkxPSIwIiB4Mj0iNTEyIiB5Mj0iNTEyIiBncmFkaWVudFVuaXRzPSJ1c2VyU3BhY2VPblVzZSI+CjxzdG9wIHN0b3AtY29sb3I9IiM2NjdlZWEiLz4KPHN0b3Agb2Zmc2V0PSIxIiBzdG9wLWNvbG9yPSIjNzY0YmEyIi8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPC9zdmc+Cg==",
                        "sizes": "512x512",
                        "type": "image/svg+xml"
                    }
                ]
            };

            // ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆã‚’Blob URLã¨ã—ã¦ä½œæˆ
            const manifestBlob = new Blob([JSON.stringify(manifestData)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(manifestBlob);
            document.getElementById('manifest-placeholder').href = manifestURL;

            // Service Workerç™»éŒ²
            if ('serviceWorker' in navigator) {
                const swCode = `
                    const CACHE_NAME = 'inventory-calculator-v1';
                    const urlsToCache = [
                        './',
                        'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTkyIiBoZWlnaHQ9IjE5MiIgdmlld0JveD0iMCAwIDE5MiAxOTIiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIxOTIiIGhlaWdodD0iMTkyIiByeD0iMjQiIGZpbGw9InVybCgjZ3JhZGllbnQwX2xpbmVhcikiLz4KPHN2ZyB4PSI0OCIgeT0iNDgiIHdpZHRoPSI5NiIgaGVpZ2h0PSI5NiIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+CjxwYXRoIGQ9Ik0yMCAzSDE0TDEwLjUgNi5MMTAgN0g0VjE4SDE4VjdIMTZMMjAgM1pNNyAxMEgxM1YxMkg3VjEwWk03IDEzSDEzVjE1SDdWMTNaTTcgMTZIMTNWMThIN1YxNloiLz4KPC9zdmc+CjxkZWZzPgo8bGluZWFyR3JhZGllbnQgaWQ9ImdyYWRpZW50MF9saW5lYXIiIHgxPSIwIiB5MT0iMCIgeDI9IjE5MiIgeTI9IjE5MiIgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiPgo8c3RvcCBzdG9wLWNvbG9yPSIjNjY3ZWVhIi8+CjxzdG9wIG9mZnNldD0iMSIgc3RvcC1jb2xvcj0iIzc2NGJhMiIvPgo8L2xpbmVhckdyYWRpZW50Pgo8L2RlZnM+Cjwvc3ZnPgo='
                    ];

                    self.addEventListener('install', function(event) {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(function(cache) {
                                    return cache.addAll(urlsToCache);
                                })
                        );
                    });

                    self.addEventListener('fetch', function(event) {
                        event.respondWith(
                            caches.match(event.request)
                                .then(function(response) {
                                    if (response) {
                                        return response;
                                    }
                                    return fetch(event.request);
                                })
                        );
                    });
                `;

                const swBlob = new Blob([swCode], {type: 'application/javascript'});
                const swURL = URL.createObjectURL(swBlob);

                navigator.serviceWorker.register(swURL)
                    .then(function(registration) {
                        console.log('Service Worker registered successfully');
                    })
                    .catch(function(error) {
                        console.log('Service Worker registration failed');
                    });
            }

            // ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
            let deferredPrompt;
            
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallBanner();
            });

            function showInstallBanner() {
                const banner = document.createElement('div');
                banner.innerHTML = `
                    <div style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                        color: white;
                        padding: 15px;
                        text-align: center;
                        z-index: 1000;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                    ">
                        <div style="margin-bottom: 10px;">ğŸ“± ã“ã®ã‚¢ãƒ—ãƒªã‚’ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã§ãã¾ã™</div>
                        <button onclick="installApp()" style="
                            background: white;
                            color: #667eea;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 20px;
                            font-weight: 600;
                            cursor: pointer;
                            margin-right: 10px;
                        ">ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«</button>
                        <button onclick="this.parentElement.parentElement.remove()" style="
                            background: transparent;
                            color: white;
                            border: 1px solid white;
                            padding: 8px 16px;
                            border-radius: 20px;
                            cursor: pointer;
                        ">å¾Œã§</button>
                    </div>
                `;
                document.body.appendChild(banner);
                
                // è‡ªå‹•çš„ã«ãƒãƒŠãƒ¼ã‚’5ç§’å¾Œã«æ¶ˆã™
                setTimeout(() => {
                    if (banner.parentElement) {
                        banner.remove();
                    }
                }, 5000);
            }

            window.installApp = function() {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            console.log('User accepted the install prompt');
                        }
                        deferredPrompt = null;
                    });
                }
                // ãƒãƒŠãƒ¼ã‚’å‰Šé™¤
                const banner = document.querySelector('[style*="position: fixed"]');
                if (banner) banner.remove();
            };
        }

        // ABCåˆ†æã«ã‚ˆã‚‹å®‰å…¨åœ¨åº«ä¿‚æ•°è¨­å®š
        const ABC_SAFETY_COEFFICIENTS = {
            A: 1.65,  // 95%ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ãƒ™ãƒ« - æ¬ å“å›é¿æœ€å„ªå…ˆ
            B: 1.28,  // 90%ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ãƒ™ãƒ« - æ¨™æº–ç®¡ç†
            C: 0.84   // 80%ã‚µãƒ¼ãƒ“ã‚¹ãƒ¬ãƒ™ãƒ« - åœ¨åº«å‰Šæ¸›é‡è¦–
        };

        function toggleDataMode(mode) {
            currentDataMode = mode;
            
            // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹åˆ‡ã‚Šæ›¿ãˆ
            document.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // æ˜¨å¹´ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤º
            const lastYearSection = document.getElementById('last-year-section');
            if (mode === 'comparison') {
                lastYearSection.style.display = 'block';
            } else {
                lastYearSection.style.display = 'none';
                // æ˜¨å¹´ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                ['last-week1', 'last-week2', 'last-week3', 'last-week4'].forEach(id => {
                    document.getElementById(id).value = '';
                });
            }
        }

        function calculateInventory() {
            // å…¥åŠ›å€¤å–å¾—
            const week1 = parseFloat(document.getElementById('week1').value) || 0;
            const week2 = parseFloat(document.getElementById('week2').value) || 0;
            const week3 = parseFloat(document.getElementById('week3').value) || 0;
            const week4 = parseFloat(document.getElementById('week4').value) || 0;
            const abcRank = document.getElementById('abc-rank').value;
            const leadTime = parseFloat(document.getElementById('lead-time').value) || 4;
            const orderCycle = parseFloat(document.getElementById('order-cycle').value) || 7;

            // å…¥åŠ›ãƒã‚§ãƒƒã‚¯
            if (week1 + week2 + week3 + week4 === 0) {
                alert('è²©å£²å®Ÿç¸¾ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }

            let calculationSteps = [];
            let modeInfo = {};

            if (currentDataMode === 'current') {
                // ä»Šå¹´ãƒ‡ãƒ¼ã‚¿ã®ã¿ãƒ¢ãƒ¼ãƒ‰
                const result = calculateCurrentOnly(week1, week2, week3, week4, abcRank, leadTime, orderCycle);
                displayResults(result.values, result.steps);
                modeInfo = {
                    title: 'ä»Šå¹´ãƒ‡ãƒ¼ã‚¿ã®ã¿ãƒ¢ãƒ¼ãƒ‰',
                    description: 'éå»4é€±é–“ã®è²©å£²å®Ÿç¸¾ã®ã¿ã‚’ä½¿ç”¨ã—ãŸè¨ˆç®—ã§ã™ã€‚'
                };
            } else {
                // æ˜¨å¹´æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰
                const lastWeek1 = parseFloat(document.getElementById('last-week1').value) || 0;
                const lastWeek2 = parseFloat(document.getElementById('last-week2').value) || 0;
                const lastWeek3 = parseFloat(document.getElementById('last-week3').value) || 0;
                const lastWeek4 = parseFloat(document.getElementById('last-week4').value) || 0;

                if (lastWeek1 + lastWeek2 + lastWeek3 + lastWeek4 === 0) {
                    alert('æ˜¨å¹´ãƒ‡ãƒ¼ã‚¿ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€ã€Œä»Šå¹´ãƒ‡ãƒ¼ã‚¿ã®ã¿ã€ãƒ¢ãƒ¼ãƒ‰ã«å¤‰æ›´ã—ã¦ãã ã•ã„ã€‚');
                    return;
                }

                const result = calculateWithComparison(
                    week1, week2, week3, week4,
                    lastWeek1, lastWeek2, lastWeek3, lastWeek4,
                    abcRank, leadTime, orderCycle
                );
                displayResults(result.values, result.steps);
                modeInfo = {
                    title: 'æ˜¨å¹´ãƒ‡ãƒ¼ã‚¿æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰',
                    description: 'æ˜¨å¹´åŒæœŸãƒ‡ãƒ¼ã‚¿ã¨æ¯”è¼ƒã—ã€å­£ç¯€æ€§ã¨ãƒˆãƒ¬ãƒ³ãƒ‰ã‚’è€ƒæ…®ã—ãŸé«˜ç²¾åº¦è¨ˆç®—ã§ã™ã€‚'
                };
            }

            // è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰è¡¨ç¤º
            document.getElementById('calculation-mode-display').innerHTML = `
                <h5>${modeInfo.title}</h5>
                <p>${modeInfo.description}</p>
            `;
        }

        function calculateCurrentOnly(week1, week2, week3, week4, abcRank, leadTime, orderCycle) {
            const totalSales = week1 + week2 + week3 + week4;
            const averageDailyDemand = totalSales / 28;
            
            // é€±å¹³å‡ã¨æ¨™æº–åå·®
            const weeklyAverage = totalSales / 4;
            const weeklyVariance = ((week1 - weeklyAverage) ** 2 + 
                                  (week2 - weeklyAverage) ** 2 + 
                                  (week3 - weeklyAverage) ** 2 + 
                                  (week4 - weeklyAverage) ** 2) / 4;
            const weeklyStdDev = Math.sqrt(weeklyVariance);
            const dailyStdDev = weeklyStdDev / Math.sqrt(7);

            // ABCå®‰å…¨åœ¨åº«ä¿‚æ•°å–å¾—
            const safetyCoeff = ABC_SAFETY_COEFFICIENTS[abcRank];

            // å®‰å…¨åœ¨åº«è¨ˆç®—
            const safetyStock = safetyCoeff * Math.sqrt(leadTime) * dailyStdDev;

            // ç™ºæ³¨ç‚¹è¨ˆç®—
            const reorderPoint = (averageDailyDemand * leadTime) + safetyStock;

            // ç™ºæ³¨é‡è¨ˆç®—ï¼ˆABCãƒ©ãƒ³ã‚¯ã«é–¢ä¿‚ãªãä¸€å¾‹ï¼‰
            const orderQuantity = averageDailyDemand * orderCycle;

            // é©æ­£åœ¨åº«è¨ˆç®—
            const maxInventory = reorderPoint + orderQuantity;

            const steps = [
                `ã€åŸºæœ¬è¨ˆç®—ã€‘`,
                `åˆè¨ˆè²©å£²æ•°: ${totalSales}å€‹`,
                `å¹³å‡æ—¥æ¬¡éœ€è¦: ${totalSales} Ã· 28 = ${averageDailyDemand.toFixed(2)}å€‹/æ—¥`,
                `é€±è²©å£²æ¨™æº–åå·®: ${weeklyStdDev.toFixed(2)}å€‹`,
                `æ—¥æ¬¡éœ€è¦æ¨™æº–åå·®: ${dailyStdDev.toFixed(2)}å€‹/æ—¥`,
                `ã€åœ¨åº«è¨ˆç®—ã€‘`,
                `å®‰å…¨åœ¨åº«ä¿‚æ•°(${abcRank}ãƒ©ãƒ³ã‚¯): ${safetyCoeff}`,
                `å®‰å…¨åœ¨åº«: ${safetyCoeff} Ã— âˆš${leadTime} Ã— ${dailyStdDev.toFixed(2)} = ${safetyStock.toFixed(1)}å€‹`,
                `ç™ºæ³¨ç‚¹: (${averageDailyDemand.toFixed(2)} Ã— ${leadTime}) + ${safetyStock.toFixed(1)} = ${reorderPoint.toFixed(1)}å€‹`,
                `ç™ºæ³¨é‡: ${averageDailyDemand.toFixed(2)} Ã— ${orderCycle} = ${orderQuantity.toFixed(1)}å€‹`,
                `é©æ­£åœ¨åº«: ${reorderPoint.toFixed(1)} + ${orderQuantity.toFixed(1)} = ${maxInventory.toFixed(1)}å€‹`
            ];

            return {
                values: {
                    dailyDemand: averageDailyDemand,
                    safetyStock: safetyStock,
                    reorderPoint: reorderPoint,
                    maxInventory: maxInventory
                },
                steps: steps
            };
        }

        function calculateWithComparison(week1, week2, week3, week4, lastWeek1, lastWeek2, lastWeek3, lastWeek4, abcRank, leadTime, orderCycle) {
            const currentTotal = week1 + week2 + week3 + week4;
            const lastYearTotal = lastWeek1 + lastWeek2 + lastWeek3 + lastWeek4;
            
            // å­£ç¯€èª¿æ•´ä¿‚æ•°
            const seasonalFactor = currentTotal / lastYearTotal;
            
            // åŸºæœ¬æ—¥æ¬¡éœ€è¦
            const baseDailyDemand = currentTotal / 28;
            
            // äºˆæ¸¬æ—¥æ¬¡éœ€è¦ï¼ˆå­£ç¯€èª¿æ•´é©ç”¨ï¼‰
            const adjustedDailyDemand = baseDailyDemand * Math.min(seasonalFactor, 2.0); // ä¸Šé™2å€ã§å®‰å…¨æ€§ç¢ºä¿
            
            // ä»Šå¹´ã®é€±å¤‰å‹•
            const currentWeeklyAvg = currentTotal / 4;
            const currentWeeklyVar = ((week1 - currentWeeklyAvg) ** 2 + 
                                   (week2 - currentWeeklyAvg) ** 2 + 
                                   (week3 - currentWeeklyAvg) ** 2 + 
                                   (week4 - currentWeeklyAvg) ** 2) / 4;
            
            // æ˜¨å¹´ã®é€±å¤‰å‹•
            const lastYearWeeklyAvg = lastYearTotal / 4;
            const lastYearWeeklyVar = ((lastWeek1 - lastYearWeeklyAvg) ** 2 + 
                                     (lastWeek2 - lastYearWeeklyAvg) ** 2 + 
                                     (lastWeek3 - lastYearWeeklyAvg) ** 2 + 
                                     (lastWeek4 - lastYearWeeklyAvg) ** 2) / 4;
            
            // å¹´é–“å¤‰å‹•ã‚’è€ƒæ…®ã—ãŸæ¨™æº–åå·®
            const combinedWeeklyVar = (currentWeeklyVar + lastYearWeeklyVar) / 2;
            const weeklyStdDev = Math.sqrt(combinedWeeklyVar);
            const dailyStdDev = weeklyStdDev / Math.sqrt(7);

            // ABCå®‰å…¨åœ¨åº«ä¿‚æ•°å–å¾—
            const safetyCoeff = ABC_SAFETY_COEFFICIENTS[abcRank];

            // å®‰å…¨åœ¨åº«è¨ˆç®—ï¼ˆèª¿æ•´ã•ã‚ŒãŸéœ€è¦ã¨ã‚ˆã‚Šç²¾å¯†ãªæ¨™æº–åå·®ã‚’ä½¿ç”¨ï¼‰
            const safetyStock = safetyCoeff * Math.sqrt(leadTime) * dailyStdDev;

            // ç™ºæ³¨ç‚¹è¨ˆç®—
            const reorderPoint = (adjustedDailyDemand * leadTime) + safetyStock;

            // ç™ºæ³¨é‡è¨ˆç®—ï¼ˆABCãƒ©ãƒ³ã‚¯ã«é–¢ä¿‚ãªãä¸€å¾‹ï¼‰
            const orderQuantity = adjustedDailyDemand * orderCycle;

            // é©æ­£åœ¨åº«è¨ˆç®—
            const maxInventory = reorderPoint + orderQuantity;

            const steps = [
                `ã€å­£ç¯€æ€§åˆ†æã€‘`,
                `ä»Šå¹´4é€±åˆè¨ˆ: ${currentTotal}å€‹`,
                `æ˜¨å¹´åŒæœŸ4é€±åˆè¨ˆ: ${lastYearTotal}å€‹`,
                `å­£ç¯€èª¿æ•´ä¿‚æ•°: ${currentTotal} Ã· ${lastYearTotal} = ${seasonalFactor.toFixed(3)}`,
                `ã€éœ€è¦äºˆæ¸¬ã€‘`,
                `åŸºæœ¬æ—¥æ¬¡éœ€è¦: ${currentTotal} Ã· 28 = ${baseDailyDemand.toFixed(2)}å€‹/æ—¥`,
                `èª¿æ•´å¾Œæ—¥æ¬¡éœ€è¦: ${baseDailyDemand.toFixed(2)} Ã— ${Math.min(seasonalFactor, 2.0).toFixed(3)} = ${adjustedDailyDemand.toFixed(2)}å€‹/æ—¥`,
                `ã€å¤‰å‹•åˆ†æã€‘`,
                `ä»Šå¹´é€±æ¨™æº–åå·®: ${Math.sqrt(currentWeeklyVar).toFixed(2)}å€‹`,
                `æ˜¨å¹´é€±æ¨™æº–åå·®: ${Math.sqrt(lastYearWeeklyVar).toFixed(2)}å€‹`,
                `çµ±åˆæ—¥æ¬¡æ¨™æº–åå·®: ${dailyStdDev.toFixed(2)}å€‹/æ—¥`,
                `ã€åœ¨åº«è¨ˆç®—ã€‘`,
                `å®‰å…¨åœ¨åº«ä¿‚æ•°(${abcRank}ãƒ©ãƒ³ã‚¯): ${safetyCoeff}`,
                `å®‰å…¨åœ¨åº«: ${safetyCoeff} Ã— âˆš${leadTime} Ã— ${dailyStdDev.toFixed(2)} = ${safetyStock.toFixed(1)}å€‹`,
                `ç™ºæ³¨ç‚¹: (${adjustedDailyDemand.toFixed(2)} Ã— ${leadTime}) + ${safetyStock.toFixed(1)} = ${reorderPoint.toFixed(1)}å€‹`,
                `ç™ºæ³¨é‡: ${adjustedDailyDemand.toFixed(2)} Ã— ${orderCycle} = ${orderQuantity.toFixed(1)}å€‹`,
                `é©æ­£åœ¨åº«: ${reorderPoint.toFixed(1)} + ${orderQuantity.toFixed(1)} = ${maxInventory.toFixed(1)}å€‹`
            ];

            return {
                values: {
                    dailyDemand: adjustedDailyDemand,
                    safetyStock: safetyStock,
                    reorderPoint: reorderPoint,
                    maxInventory: maxInventory
                },
                steps: steps
            };
        }

        function displayResults(values, steps) {
            document.getElementById('daily-demand').textContent = values.dailyDemand.toFixed(1);
            document.getElementById('safety-stock').textContent = Math.ceil(values.safetyStock);
            document.getElementById('reorder-point').textContent = Math.ceil(values.reorderPoint);
            document.getElementById('max-inventory').textContent = Math.ceil(values.maxInventory);

            document.getElementById('calculation-steps').innerHTML = 
                steps.map(step => `<div class="calculation-step">${step}</div>`).join('');

            // çµæœã‚¨ãƒªã‚¢è¡¨ç¤º
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        }

        // Enterã‚­ãƒ¼ã§è¨ˆç®—å®Ÿè¡Œ
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculateInventory();
            }
        });
    </script>
</body>
</html>